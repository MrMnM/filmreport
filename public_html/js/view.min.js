"https:"!==location.protocol&&(location.protocol="https:");import Project from"./Project.js";import{roundToTwo,addTimes,timeToMins,minsToHours,formatDateFilename,formatDateSwiss}from"./timeHelpers.js";const us_id="guest";let url=new URL(window.location.href);const p_id=url.searchParams.get("id"),p=new Project(p_id);let dat={},clc={};function loadChats(){p.getChats().then(()=>{if(""!=p.chatViewHtml)$("#chats").html(p.chatViewHtml);else{let t='\n      <li class="divider"></li>\n      <li>\n        <div>\n          <strong> </strong>\n            <span class="pull-right text-muted">\n            <em> </em></span>\n        </div>\n        <div>Noch keine Kommentare</div>\n      </li>';$("#chats").html(t)}})}$("#submitComment").click(t=>{t.preventDefault(),addChat($("#commentText").val())}),$("#navAbr").click(t=>{t.preventDefault(),$("#rapport").hide(),$("#spesen").hide(),$("#abrechnung").show()}),$("#navRap").click(t=>{t.preventDefault(),$("#rapport").show(),$("#abrechnung").hide(),$("#spesen").hide()}),$("#navExp").click(t=>{t.preventDefault(),$("#spesen").show(),$("#rapport").hide(),$("#abrechnung").hide()});var loadViewData=new Promise((t,e)=>{$.ajax({url:"https://filmstunden.ch/api/v01/view/"+p_id,type:"GET",dataType:"json"}).done(o=>{(dat=o)[0].companyData||e(),t()})});function addChat(t){$(".hideSend").hide(),$.ajax({url:"https://filmstunden.ch/api/v01/chats/"+p_id,xhrFields:{withCredentials:!0},dataType:"json",data:{text:t},type:"POST"}).done(()=>{loadChats(),$(".hideSend").show()}).fail(()=>{loadChats(),$(".hideSend").show()})}function refreshView(){const t=dat[0].userData,e=dat[0].companyData,o=dat[0].projectData;clc=o.settings;const a=formatDateFilename(o.p_end)+"_"+o.p_name.replace(/ /g,"_")+"_"+t.name.replace(/ /g,"_");document.title=a,$(".hoursperday").html(`(${clc.hoursDay}h / Tag)`),$(".tohoursperday").html(`(bis ${clc.hoursDay}h/Tag)<font class="f9"><sup>1</sup></font>`),$(".fromhoursperday").html(`&Uuml;berstunden <font class="f9"><sup>2</sup></font><font class="f6">(${clc.hoursDay}h +)</font>`),$("#otText").html(`2 &Uuml;berstunden: Bei mehr als ${clc.hoursDay} h pro Tag auf der Basis von 1/${clc.hoursDay} Tag.`),$("#1Over").html(`${clc.hoursDay+1}.te`),$("#2Over").html(`${clc.hoursDay+2}.te`),$("#3Over").html(`${clc.hoursDay+3}.te`),$("#4Over").html(`${clc.hoursDay+4}.te`),$("#5Over").html(`${clc.hoursDay+5}.te`),$("#6Over").html(`${clc.hoursDay+6}.te`),$("#7Over").html(`ab </br>${clc.hoursDay+7}.ter`),$(".gage").html(o.p_gage),$(".foodrate").html(clc.lunch),$(".kilrate").html(clc.car),$(".startdate").html(formatDateSwiss(o.p_start)),$(".enddate").html(formatDateSwiss(o.p_end)),$(".projectname").html(o.p_name),$(".job").html(o.p_job),$(".username").html(t.name),$(".u_address1").html(t.address_1),$(".u_address2").html(t.address_2),$(".ahv").html(t.ahv),$(".dob").html(formatDateSwiss(t.dateob)),$(".tel").html(`<a href="tel:${t.tel}">${t.tel}</a>`),$(".konto").html(t.konto),$(".mail").html(`<a href="mailto:${t.mail}">${t.mail}</a>`),$(".bvg").html(t.bvg),$(".company").html(`<a href="${e.url}">${e.c_name}</a>`),$(".c_addr1").html(`<a href="${e.url}">${e.c_address_1}</a>`),$(".c_addr2").html(`<a href="${e.url}">${e.c_address_2}</a>`),$("#dateFromTo").html(formatDateSwiss(o.p_start)+" bis "+formatDateSwiss(o.p_end)),$("#pay_additional").html(),$("#comments").html(o.p_comment),$("#ab_rappnr").html(p_id.substring(0,5)),refreshProjectList(o,clc),refreshExpenseList(o),refreshAbrechnungList(clc)}function refreshProjectList(t,e){let o=[0,0,0,0],a=0,r=0,l=0,n=0,s=[0,0,0,0,0];s[0]=t.p_gage/e.hoursDay*e.rate[0],s[1]=t.p_gage/e.hoursDay*e.rate[1],s[2]=t.p_gage/e.hoursDay*e.rate[2],s[3]=t.p_gage/e.hoursDay*e.rate[3],s[4]=t.p_gage/e.hoursDay*e.rate[4];let d="";for(let e of t.p_json){o[0]+=e.overtime[0]+e.overtime[1],o[1]+=e.overtime[2]+e.overtime[3],o[2]+=e.overtime[4]+e.overtime[5],o[3]+=e.overtime[6],a+=e.night,r+=parseFloat(e.base),l+=Number(timeToMins(e.workhours));let t=`<tr>\n    <td class="td186 td187" colspan="2" height="30">${formatDateSwiss(e.date)}</td>\n    <td class="td186 td187" colspan="2">${e.work}</td>\n    <td class="td186">${e.start}</td>\n    <td class="td186">${e.end}</td>\n    <td class="td186">${e.break}</td>\n    <td class="td186">${e.workhours}</td>\n    <td></td>\n    <td class="darkyellow bold">${e.base}</td>\n    <td></td>\n    <td class="${e.overtime[0]?"brightorange":"medorange"}">${e.overtime[0]?e.overtime[0]:"&nbsp;"}</td>\n    <td class="${e.overtime[1]?"brightorange":"medorange"}">${e.overtime[1]?e.overtime[1]:"&nbsp;"}</td>\n    <td class="${e.overtime[2]?"brightorange":"medorange"}">${e.overtime[2]?e.overtime[2]:"&nbsp;"}</td>\n    <td class="${e.overtime[3]?"brightorange":"medorange"}">${e.overtime[3]?e.overtime[3]:"&nbsp;"}</td>\n    <td class="${e.overtime[4]?"brightorange":"medorange"}">${e.overtime[4]?e.overtime[4]:"&nbsp;"}</td>\n    <td class="${e.overtime[5]?"brightorange":"medorange"}">${e.overtime[5]?e.overtime[5]:"&nbsp;"}</td>\n    <td class="${e.overtime[6]?"brightorange":"medorange"}">${e.overtime[6]?e.overtime[6]:"&nbsp;"}</td>\n    <td class="${e.night?"brightorange":"medorange"}" colspan="2">${e.night?e.night:"&nbsp;"}</td>\n    <td></td>\n    <td></td>\n    <td class="${e.lunch?"darkgreen":"brightgreen"}">${e.lunch?"1":"&nbsp;"}</td>\n    <td class="${e.car?"darkgreen":"brightgreen"}">${e.car?e.car:"&nbsp;"}</td>\n    </tr>`;e.lunch&&(n+=1),d+=t}$("#fromhere").after(d),$("#overtime1").html(roundToTwo(o[0])),$("#overtime2").html(roundToTwo(o[1])),$("#overtime3").html(roundToTwo(o[2])),$("#overtime4").html(roundToTwo(o[3])),$("#nighttime").html(roundToTwo(a)),$("#nrOfDays").html(roundToTwo(r)),$("#totalWorkHours").html(minsToHours(l)),$("#rate125").html(roundToTwo(s[0])),$("#rate150").html(roundToTwo(s[1])),$("#rate200").html(roundToTwo(s[2])),$("#rate250").html(roundToTwo(s[3])),$("#rate25").html(roundToTwo(s[4])),$("#pay125").html(roundToTwo(s[0]*o[0])),$("#pay150").html(roundToTwo(s[1]*o[1])),$("#pay200").html(roundToTwo(s[2]*o[2])),$("#pay250").html(roundToTwo(s[3]*o[3])),$("#pay25").html(roundToTwo(s[4]*a)),$("#payBase").html(roundToTwo(t.p_gage*r)),$("#totalBase").html(roundToTwo(t.p_gage*r)),$("#totalOvertime").html(roundToTwo(s[0]*o[0]+s[1]*o[1]+s[2]*o[2]+s[3]*o[3]+s[4]*a)),$("#totalAdditional").html(roundToTwo(n*e.lunch+0*e.car)),$(".alllunches").html(n),$(".allcar").html(0)}function refreshAbrechnungList(t,e){const o=dat[0].projectData;let a=[0,0,0,0,0];a[0]=o.p_gage/t.hoursDay*t.rate[0],a[1]=o.p_gage/t.hoursDay*t.rate[1],a[2]=o.p_gage/t.hoursDay*t.rate[2],a[3]=o.p_gage/t.hoursDay*t.rate[3],a[4]=o.p_gage/t.hoursDay*t.rate[4];let r=0,l=0,n=[0,0,0,0],s=0,d="";for(let t of o.p_json)if(r+=parseFloat(t.base),l+=o.p_gage*t.base,n[0]+=t.overtime[0]+t.overtime[1],n[1]+=t.overtime[2]+t.overtime[3],n[2]+=t.overtime[4]+t.overtime[5],n[3]+=t.overtime[6],s+=t.night,!e){d+=`<tr>\n      \t\t\t\t\t\t<td class="bryellow f8">${formatDateSwiss(t.date)}</td>\n      \t\t\t\t\t\t<td class="bryellow f8">${t.work}</td>\n      \t\t\t\t\t\t<td class="ab_darkyellow f8">${t.base}</td>\n      \t\t\t\t\t\t<td class="f8">&nbsp;</td>\n      \t\t\t\t\t\t<td class="bryellow f8">Tag</td>\n      \t\t\t\t\t\t<td class="bryellow f8">${o.p_gage}</td>\n      \t\t\t\t\t\t<td class="bryellow f8" colspan="2">${o.p_gage*t.base}</td>\n      \t\t\t\t\t</tr>`}const h=l*t.ferien,m=l+h,i=n[0]*a[0]+n[1]*a[1]+n[2]*a[2]+n[3]*a[3]+s*a[4],c=m+i,u=c*t.ahv,p=c*t.alv,g=c*t.bvg,T=c*t.uvg,f=u+p+g+T,w=c-f,v=calculateExpenses(o),b=0*t.car+0*t.lunch+v,_=w+b;e||$("#abr_baselist").after(d),$(".totalBase").html(l),$("#totalDays").html(roundToTwo(r)),$("#ferienzulage").html(roundToTwo(h)),$("#lohnundfz").html(m),$("#abr_ot0").html(roundToTwo(n[0])),$("#abr_ot1").html(roundToTwo(n[1])),$("#abr_ot2").html(roundToTwo(n[2])),$("#abr_ot3").html(roundToTwo(n[3])),$("#abr_nt").html(roundToTwo(s)),$("#rate0").html(roundToTwo(a[0])),$("#rate1").html(roundToTwo(a[1])),$("#rate2").html(roundToTwo(a[2])),$("#rate3").html(roundToTwo(a[3])),$("#rate4").html(roundToTwo(a[4])),$("#ot0").html(roundToTwo(n[0]*a[0])),$("#ot1").html(roundToTwo(n[1]*a[1])),$("#ot2").html(roundToTwo(n[2]*a[2])),$("#ot3").html(roundToTwo(n[3]*a[3])),$("#ot4").html(roundToTwo(s*a[4])),$("#totalUeberstunden").html(roundToTwo(i)),$(".totalBrutto").html(roundToTwo(c)),$("#abzAhv").html(roundToTwo(u)),$("#abzAlv").html(roundToTwo(p)),$("#abzBvg").html(roundToTwo(g)),$("#abzUvg").html(roundToTwo(T)),$("#totalAbz").html(roundToTwo(f)),$("#totalNetto").html(roundToTwo(w)),$("#totalSpesen").html(roundToTwo(b)),$("#total").html(roundToTwo(_))}function refreshExpenseList(t){let e=calculateExpenses(t),o="";if(0!=t.expenses.length)for(let e of t.expenses)""!=e.img?o+=`<tr>\n                        <td class="blue fs8">${formatDateSwiss(e.date)}</td>\n                        <td class="blue fs8"><a href="#" data-featherlight="https://filmstunden.ch/upload/${e.img}">${e.name}</a></td>\n                        <td class="blue fs8" colspan="6"><a href="#" data-featherlight="https://filmstunden.ch/upload/${e.img}">${e.comment}</a></td>\n                        <td class="blue fs8 bold">${e.value}</td>\n                        </tr>`:o+=`<tr>\n                        <td class="blue fs8">${formatDateSwiss(e.date)}</td>\n                        <td class="blue fs8">${e.name}</td>\n                        <td class="blue fs8" colspan="6">${e.comment}</td>\n                        <td class="blue fs8 bold">${e.value}</td>\n                        </tr>`;else o='<td class="blue fs8" height="30" style="text-align: center; font-weight: 700" colspan="9">Keine zus&auml;tzlichen Spesen angegeben</td>';$("#expenseList").after(o),$(".additionalExpense").html(roundToTwo(e))}function calculateExpenses(t){let e=0;if(0!=t.expenses.length)for(let o of t.expenses)e+=parseFloat(o.value);return e}document.getElementById("percALV").onchange=(()=>{clc.alv=parseFloat(.01*document.getElementById("percALV").value),refreshAbrechnungList(clc,!0)}),document.getElementById("percNBU").onchange=(()=>{clc.uvg=parseFloat(.01*document.getElementById("percNBU").value),refreshAbrechnungList(clc,!0)}),$(()=>{Promise.all([loadViewData,loadChats()]).then(()=>{refreshView(),$("#exceldownload").attr("href","https://filmstunden.ch/api/v01/view/download/"+p_id+"?format=xlsx"),$("#pdfdownload").attr("href","https://filmstunden.ch/api/v01/view/download/"+p_id+"?format=pdf"),$("#loading").hide(),$("#rapport").show()}).catch(()=>{$("#loading").hide(),$("#noProject").show()}),$("ul.nav li").on("click",function(){$(this).parent().find("li.active").removeClass("active"),$(this).addClass("active")})});